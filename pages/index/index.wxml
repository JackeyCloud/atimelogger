<!-- pages/index/index.wxml -->
<view class="page-container">
  <guide-tip wx:if="{{showAddToMPTip}}" type="addToMiniProgram" show="{{showAddToMPTip}}" bind:close="onAddToMPTipClose"></guide-tip>
  <guide-tip wx:if="{{showAddToDesktopTip && !showAddToMPTip}}" type="addToDesktop" show="{{showAddToDesktopTip}}" bind:close="onAddToDesktopTipClose"></guide-tip>
  <feature-carousel id="featureCarousel" show="{{showFeatureCarousel}}" bind:close="onFeatureCarouselClose"></feature-carousel>
  <view class="container {{pageThemeClass}}">
  <!-- 添加/编辑类别模态框 -->
  <view class="modal {{showAddCategoryModal ? 'show' : ''}}" wx:if="{{showAddCategoryModal}}">
    <view class="modal-mask" bindtap="closeModal"></view>
    <view class="modal-content" animation="{{animationData}}">
      <view class="modal-header">
        <text class="modal-title">添加类别</text>
        <view class="close-button" bindtap="closeModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="input-group">
          <text class="input-label">名称</text>
          <input class="input-field" value="{{newCategory.name}}" bindinput="inputCategoryName" placeholder="输入类别名称" />
        </view>
        
        <view class="input-group">
          <text class="input-label">颜色</text>
          <view class="color-options">
            <block wx:for="{{colorOptions}}" wx:key="*this">
              <view class="color-option {{newCategory.color === item ? 'selected' : ''}}" 
                style="background-color: {{item}}" 
                bindtap="selectColor" 
                data-color="{{item}}">
              </view>
            </block>
          </view>
        </view>
        
        <view class="input-group">
          <text class="input-label">图标</text>
          
          <!-- 图标分类选择器 -->
          <view class="icon-category-tabs">
            <block wx:for="{{iconCategories}}" wx:key="name" wx:for-index="index">
              <view class="icon-category-tab {{selectedIconCategory === index ? 'active' : ''}}" 
                bindtap="switchIconCategory" 
                data-index="{{index}}">
                <text class="category-tab-icon">{{item.icon}}</text>
                <text class="category-tab-name">{{item.name}}</text>
              </view>
            </block>
          </view>
          
          <!-- 当前分类的图标选项 -->
          <view class="icon-options">
            <block wx:for="{{iconCategories[selectedIconCategory].icons}}" wx:key="*this">
              <view class="icon-option {{newCategory.icon === item ? 'selected' : ''}}" 
                bindtap="selectIcon" 
                data-icon="{{item}}">
                <text>{{item}}</text>
              </view>
            </block>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-button" bindtap="closeModal">取消</button>
        <button class="save-button" bindtap="saveCategory">保存</button>
      </view>
    </view>
  </view>

  <!-- 活动记录卡片 -->
  <view class="active-record-container" wx:if="{{activeRecord}}">
    <view class="active-record-card">
      <view class="active-record-header">
        <view class="category-icon" style="background-color: {{activeRecord.category.color}}">
          <text class="icon-text">{{activeRecord.category.icon}}</text>
        </view>
        <view class="category-info">
          <text class="category-name">{{activeRecord.category.name}}</text>
          <text class="category-time">开始于 {{activeRecord.formattedStartTime}}</text>
        </view>
      </view>
      
      <view class="timer-display">
        <text class="timer-text">{{timerDisplay}}</text>
      </view>
      
      <view class="record-actions">
        <button wx:if="{{!isPaused}}" class="btn btn-warning" bindtap="pauseRecord">暂停</button>
        <button wx:if="{{isPaused}}" class="btn btn-primary" bindtap="resumeRecord">继续</button>
        <button class="btn btn-danger" bindtap="stopRecord">停止记录</button>
      </view>
    </view>
  </view>
  
  <!-- 类别选择网格 -->
  <view class="categories-container">
    <!-- 预设功能开关 -->
    <view class="preset-toggles-container">
      <view class="preset-toggle-item" bindtap="debugPresetDurationStatus">
        <text class="preset-toggle-label">预设时长</text>
        <switch class="preset-toggle-switch" checked="{{usePresetDuration}}" bindchange="toggleUsePresetDuration" catchtap="preventBubble"></switch>
      </view>
      <view class="preset-toggle-item">
        <text class="preset-toggle-label">预设备注</text>
        <switch class="preset-toggle-switch" checked="{{usePresetNote}}" bindchange="toggleUsePresetNote"></switch>
      </view>
    </view>
    
    <!-- 预设时长选择器 -->
    <view class="preset-duration-container" wx:if="{{showPresetDuration}}">
      <view class="preset-header">
        <text class="preset-title">选择预设时长</text>
        <view class="close-button" bindtap="togglePresetDuration">×</view>
      </view>
      <view class="preset-options">
        <view class="preset-option {{selectedPreset === 25 ? 'selected' : ''}}" bindtap="selectPreset" data-duration="25">
          <text class="preset-value">25分钟</text>
          <text class="preset-desc">专注时间</text>
        </view>
        <view class="preset-option {{selectedPreset === 45 ? 'selected' : ''}}" bindtap="selectPreset" data-duration="45">
          <text class="preset-value">45分钟</text>
          <text class="preset-desc">深度工作</text>
        </view>
        <view class="preset-option {{selectedPreset === 60 ? 'selected' : ''}}" bindtap="selectPreset" data-duration="60">
          <text class="preset-value">60分钟</text>
          <text class="preset-desc">长时专注</text>
        </view>
        <view class="preset-option {{selectedPreset === 5 ? 'selected' : ''}}" bindtap="selectPreset" data-duration="5">
          <text class="preset-value">5分钟</text>
          <text class="preset-desc">短暂休息</text>
        </view>
        <view class="preset-option {{selectedPreset === 15 ? 'selected' : ''}}" bindtap="selectPreset" data-duration="15">
          <text class="preset-value">15分钟</text>
          <text class="preset-desc">休息时间</text>
        </view>
        <view class="preset-option custom {{isCustomSelected ? 'selected' : ''}}" bindtap="showCustomDurationInput">
          <text class="preset-value">{{customDisplayText}}</text>
          <text class="preset-desc">分钟</text>
        </view>
      </view>
      <view class="custom-duration-input" wx:if="{{showCustomDurationInput}}">
        <input type="number" class="duration-input" value="{{customDuration}}" bindinput="onCustomDurationInput" placeholder="输入分钟数"/>
        <button class="confirm-button" bindtap="confirmCustomDuration">确定</button>
      </view>
      <button class="start-preset-button" bindtap="startPresetTimer">开始计时</button>
    </view>
    
    <view class="categories-grid {{isDragging ? 'dragging-mode' : ''}}">
      <block wx:for="{{categories}}" wx:key="id">
        <view 
          class="category-item {{isDragging && draggedIndex === index ? 'dragging' : ''}} {{isDragging && dragOverIndex === index ? 'drag-over' : ''}}" 
          bindtap="{{isDragging ? 'onCategoryTapInDragMode' : (usePresetDuration ? 'showPresetForCategory' : 'startRecord')}}" 
          bindlongpress="onCategoryLongPress"
          bindtouchstart="onCategoryTouchStart"
          bindtouchmove="onCategoryTouchMove"
          bindtouchend="onCategoryTouchEnd"
          data-id="{{item.id}}"
          data-index="{{index}}">
          
          <view class="category-icon" style="background-color: {{item.color}}">
            <text class="icon-text">{{item.icon}}</text>
          </view>
          <text class="category-name">{{item.name}}</text>
          
          <!-- 拖拽模式下的视觉指示器 -->
          <view class="drag-indicator" wx:if="{{isDragging && draggedIndex === index}}">
            <text class="drag-icon">⋮⋮</text>
          </view>
        </view>
      </block>
      
      <view class="category-item add-category" bindtap="showAddCategory">
        <view class="category-icon add-icon">
          <text class="icon-text">+</text>
        </view>
        <text class="category-name">添加</text>
      </view>
    </view>
    
    <!-- 拖拽排序模式下的操作提示 -->
    <view class="drag-sort-tips" wx:if="{{isDragging}}">
      <text class="drag-tips-text">点击其他类别位置进行交换</text>
      <button class="exit-drag-button" bindtap="cancelDragSort">完成</button>
    </view>
  </view>
  <!-- 提示信息 -->
  <view class="tips-container" wx:if="{{!activeRecord}}">
    <view class="tips">
      <text class="tips-text">点击上方类别开始记录时间</text>
    </view>
  </view>

  <!-- 预设备注输入框 -->
  <view class="modal {{showPresetNoteModal ? 'show' : ''}}" wx:if="{{showPresetNoteModal}}">
    <view class="modal-mask" bindtap="hidePresetNoteModal"></view>
    <view class="modal-content preset-note-modal">
      <view class="modal-header">
        <text class="modal-title">添加备注</text>
        <view class="close-button" bindtap="hidePresetNoteModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="note-input-group">
          <text class="note-input-label">备注</text>
          <textarea 
            class="note-textarea" 
            value="{{presetNote}}" 
            bindinput="onPresetNoteInput" 
            placeholder="请输入本次记录的备注信息..."
            maxlength="200"
            auto-height
            show-confirm-bar="{{false}}">
          </textarea>
          <text class="note-char-count">{{presetNote.length}}/200</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-button" bindtap="hidePresetNoteModal">取消</button>
        <button class="confirm-button" bindtap="confirmPresetNote">开始记录</button>
      </view>
    </view>
  </view>
</view>
</view>
